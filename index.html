<head>
  <title>Le pont</title>
  <meta charset="utf-8">
</head>

<link rel="stylesheet" type="text/css" href="srt.css">

<body id="body" onload="zoupage()">
  <div id="container3">
    <div id="container2">
      <div id="container1">
        <div id="srt">
          Bonjour
        </div>
        <div id="checklist">
        </div>
        <div id="sacbouttons">
        </div>
        <div id="fiction">
        </div>
      </div>
    </div>
    <script>

    // TO DO
    // balises pour afficher du texte ailleurs que dans SRT (checklist, rubrique fiction)
    /* il se passe un truc bien chelou avec le parseur, genre soit il regex les balises correctement et 
    et rajoute des \n parfois en début de ligne, soit il fait nimp avec les balises quand elles sont à la suite
    les unes des autres mais parse les autres lignes correctement. Quand on change l'ordre de chaque regex
    dans index.js ça change le type de bug GNEIRK
    */
    // doublon balise / type

    var compteur = 0

    var balise
    var _balise

    var data = []

    function loadJSON(callback) {   

      var xobj = new XMLHttpRequest();
      xobj.overrideMimeType("application/json");
    xobj.open('GET', '/libs/output.json', true); // Replace 'my_data' with the path to your file
    xobj.onreadystatechange = function () {
      if (xobj.readyState == 4 && xobj.status == "200") {
            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
            callback(xobj.responseText);
          }
        };
        xobj.send(null);  
      }

//usage:
function zoupage() {

 loadJSON(function(response) {
  // Parse JSON string into object
  var actual_JSON = JSON.parse(response);

  for(i=0; i<actual_JSON.length; i++){
    if(actual_JSON[i]["type"] == "text" ){
      data.push(actual_JSON[i]["text"])
    }
    if(actual_JSON[i]["type"] == "balise"){
      data.push(actual_JSON[i])
    }       

  }

});
}

function next(){
  console.log(compteur)
  var currentSub = data[compteur]
  document.getElementById("srt").innerHTML = currentSub

  balise = data[compteur]["balise"]

  if(_balise != balise){

    // quand tu tombes sur une balise crac passe des arguments
    // à action qui décide quoi faire du coup.
    action(data[compteur]["balise"], data[compteur]["text"])

    balise = _balise
    compteur+=1
    next()
  }

}

function action(type, commande){

  switch(type){
    case "b":
    // BOUTTON
    // trigger pour faire apparaître les boutons

    // supprime les anciens bouttons
    var sacbouttons = document.getElementById("sacbouttons");
    while (sacbouttons.firstChild) {
      sacbouttons.removeChild(sacbouttons.firstChild);
    }

    // récupère le texte en provenance du tableau JSON et lui regex la gueule
    var buttonsname = commande.match(/[^\s\d]\w+/g)
    var howmuch = buttonsname.length


    // créé un boutton par mot (mais euh ben du coup on peu pas faire des bouttons avec des mots en deux parties)
    for(i=0; i<howmuch; i+=2){
      var button = document.createElement("input")
      button.type = "button"
      button.id = buttonsname[i]
      button.value = buttonsname[i]
      button.onclick = clicboutton
      sacbouttons.appendChild(button)
      document.getElementById("sacbouttons").style.opacity = "1"
    }
    break;

    case "c":
    // CHECKLIST
    // trigger pour renseigner la bd de checklist (!!!!WIP!!!!)
    var checklistname = commande.match(/([^\,]+)/g)
    var howmuch = checklistname.length

    for(i=0; i<howmuch; i++){
      console.log(checklistname)
    }

    case "f":
    // FICTION
    // trigger pour afficher un string dans la rubrique fiction
    var content = commande
    document.getElementById("fiction").innerHTML = content

  }

}

function clicboutton(){
  newchecklist(this.id)
  document.getElementById("sacbouttons").style.opacity = "0";
  compteur +=1
  next()
}

function newchecklist(){

}

document.onkeydown = function(e) {

  e = e || window.event


  // KEYCODE 32 IS SPACEBAR
  // KEYCIODE 78 IS "n"

  if(e.keyCode =='32' && compteur <= data.length){
    compteur +=1
    document.getElementById("container"+compteur).style.opacity = "0";
    document.getElementById("container3").webkitRequestFullscreen();
  next();
}

}

</script>

</body>

